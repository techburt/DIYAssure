<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIYAssure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Simple screen transition */
        .screen { display: none; }
        .screen.active { display: flex; }
        html, body { height: 100%; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased h-full flex flex-col">

    <!-- Main Application Container -->
    <div id="app-container" class="w-full max-w-md mx-auto bg-white shadow-lg h-full flex flex-col">

        <!-- Login Screen -->
        <div id="login-screen" class="screen active flex-col justify-center items-center p-8 text-center flex-grow">
            <img src="DIYAssure Logo to start 2.png" alt="DIYAssure Logo" class="h-24 w-24 mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Welcome to DIYAssure</h1>
            <p class="text-gray-600 mt-2 mb-8">Your AI partner for home improvement projects.</p>
            <button id="google-signin-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center space-x-2">
                <i data-lucide="log-in"></i>
                <span>Sign In with Google</span>
            </button>
        </div>
        
        <!-- Onboarding Screen -->
        <div id="onboarding-screen" class="screen flex-col p-6 flex-grow">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Welcome!</h2>
            <p class="text-gray-600 mb-6">Let's set up your DIY profile.</p>
            <form id="onboarding-form">
                <div class="mb-4">
                    <label for="overall-skill" class="block text-sm font-medium text-gray-700 mb-1">Overall Skill Level</label>
                    <select id="overall-skill" name="overallSkill" class="w-full p-2 border border-gray-300 rounded-lg" required>
                        <option value="Novice">Novice (Just starting out)</option>
                        <option value="Intermediate">Intermediate (Done a few projects)</option>
                        <option value="Expert">Expert (Very experienced)</option>
                    </select>
                </div>
                 <p class="text-sm font-medium text-gray-700 mb-2">Domain Skills (Optional)</p>
                 <div class="space-y-3">
                    <div>
                        <label for="carpentry-skill" class="block text-xs text-gray-600">Carpentry</label>
                        <select id="carpentry-skill" name="carpentry" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="Novice">Novice</option>
                            <option value="Intermediate" selected>Intermediate</option>
                            <option value="Expert">Expert</option>
                        </select>
                    </div>
                     <div>
                        <label for="plumbing-skill" class="block text-xs text-gray-600">Plumbing</label>
                        <select id="plumbing-skill" name="plumbing" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="Novice" selected>Novice</option>
                            <option value="Intermediate">Intermediate</option>
                            <option value="Expert">Expert</option>
                        </select>
                    </div>
                     <div>
                        <label for="electrical-skill" class="block text-xs text-gray-600">Electrical</label>
                        <select id="electrical-skill" name="electrical" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="Novice" selected>Novice</option>
                            <option value="Intermediate">Intermediate</option>
                            <option value="Expert">Expert</option>
                        </select>
                    </div>
                 </div>
                <div class="mt-8">
                    <button type="submit" class="w-full bg-sky-600 text-white font-bold py-3 rounded-lg hover:bg-sky-700">Save Profile</button>
                </div>
            </form>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboard-screen" class="screen flex-col flex-grow">
            <header class="bg-white sticky top-0 z-10 shadow-sm">
                <div class="px-4 py-3 flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <img src="DIYAssure Logo to start 2.png" alt="DIYAssure Logo" class="h-10 w-10">
                    </div>
                    <button id="signout-btn" class="text-gray-500 hover:text-sky-600">
                        <i data-lucide="log-out"></i>
                    </button>
                </div>
            </header>
            <main class="flex-grow p-4 overflow-y-auto">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">My Projects</h2>
                <div id="project-list" class="space-y-4">
                    <!-- Projects will be dynamically inserted here -->
                     <p id="no-projects-msg" class="text-center text-gray-500 mt-8">You don't have any projects yet. Start a new one below!</p>
                </div>
            </main>
            <div class="p-4 sticky bottom-0 bg-white bg-opacity-80 backdrop-blur-sm border-t">
                <button id="new-project-btn" class="w-full bg-sky-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:bg-sky-700 transition-colors flex items-center justify-center space-x-2">
                    <i data-lucide="plus-circle"></i>
                    <span>Start New Project</span>
                </button>
            </div>
        </div>

        <!-- Project Hub Screen -->
        <div id="project-hub-screen" class="screen flex-col flex-grow">
             <header class="bg-white sticky top-0 z-10 shadow-md">
                <div class="px-4 py-3 flex items-center">
                    <button class="text-gray-500 hover:text-sky-600 mr-3" onclick="navigateTo('dashboard-screen')">
                        <i data-lucide="arrow-left"></i>
                    </button>
                    <h2 id="hub-project-title" class="text-lg font-bold text-gray-800 truncate">Project Title</h2>
                </div>
            </header>
            <main id="project-tasks-container" class="flex-grow p-4 overflow-y-auto">
                 <!-- Tasks will be dynamically inserted here -->
            </main>
        </div>
        
        <!-- New Project Modal -->
        <div id="new-project-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden justify-center items-center">
            <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-md">
                <h3 class="text-xl font-bold mb-4">Start a New Project</h3>
                <form id="new-project-form">
                    <div class="mb-4">
                        <label for="project-title" class="block text-sm font-medium text-gray-700">Project Title</label>
                        <input type="text" id="project-title" class="mt-1 w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., Install New Interior Door" required>
                    </div>
                    <div class="mb-4">
                        <label for="project-description" class="block text-sm font-medium text-gray-700">Project Description</label>
                        <textarea id="project-description" rows="3" class="mt-1 w-full p-2 border border-gray-300 rounded-lg" placeholder="Add more details, like material types, room dimensions, etc."></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-project-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                        <button type="submit" id="create-project-btn" class="bg-sky-600 text-white px-4 py-2 rounded-lg hover:bg-sky-700 flex items-center">
                            <span id="create-btn-text">Generate Plan</span>
                            <div id="create-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white ml-2"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, onSnapshot, query, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL CONFIG & STATE ---
        const firebaseConfig = {
          apiKey: "AIzaSyAgIQXqOl3NMMC5QmzHgsgm-SGJm_F8MLE",
          authDomain: "diyassure.firebaseapp.com",
          projectId: "diyassure",
          storageBucket: "diyassure.firebasestorage.app",
          messagingSenderId: "890016430107",
          appId: "1:890016430107:web:90bf1ff7329bfa643f20be",
          measurementId: "G-JQ9JPGDEPD"
        ;
        
        let app, auth, db;
        let currentUser = null;
        let userProfile = null;

        // --- UI ELEMENTS ---
        const screens = document.querySelectorAll('.screen');
        const newProjectModal = document.getElementById('new-project-modal');

        // --- NAVIGATION ---
        function navigateTo(screenId) {
            screens.forEach(screen => {
                screen.classList.toggle('active', screen.id === screenId);
            });
            lucide.createIcons();
        }

        // --- FIREBASE INITIALIZATION & AUTH ---
        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setupAuthListeners();
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                // Handle error for user, e.g., show an error message.
            }
        }

        function setupAuthListeners() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    await checkUserProfile();
                } else {
                    currentUser = null;
                    userProfile = null;
                    navigateTo('login-screen');
                }
            });
        }
        
        async function checkUserProfile() {
            const userRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/profile`, 'data');
            const userSnap = await getDoc(userRef);

            if (userSnap.exists()) {
                userProfile = userSnap.data();
                navigateTo('dashboard-screen');
                loadProjects();
            } else {
                navigateTo('onboarding-screen');
            }
        }
        
        document.getElementById('google-signin-btn').addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In failed:", error);
            }
        });

        document.getElementById('signout-btn').addEventListener('click', () => signOut(auth));

        // --- ONBOARDING ---
        document.getElementById('onboarding-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const profileData = {
                name: currentUser.displayName,
                email: currentUser.email,
                overallSkill: formData.get('overallSkill'),
                domainSkills: {
                    carpentry: formData.get('carpentry'),
                    plumbing: formData.get('plumbing'),
                    electrical: formData.get('electrical'),
                }
            };

            const userRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/profile`, 'data');
            await setDoc(userRef, profileData);
            userProfile = profileData;
            navigateTo('dashboard-screen');
            loadProjects();
        });


        // --- PROJECT MANAGEMENT ---
        function loadProjects() {
            if (!currentUser) return;
            const projectsRef = collection(db, `artifacts/${appId}/users/${currentUser.uid}/projects`);
            const q = query(projectsRef);

            onSnapshot(q, (snapshot) => {
                const projectList = document.getElementById('project-list');
                const noProjectsMsg = document.getElementById('no-projects-msg');
                projectList.innerHTML = '';
                if (snapshot.empty) {
                    noProjectsMsg.style.display = 'block';
                } else {
                    noProjectsMsg.style.display = 'none';
                    snapshot.docs.forEach(doc => {
                        const project = doc.data();
                        const projectEl = document.createElement('div');
                        projectEl.className = "bg-white p-4 rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:shadow-md";
                        projectEl.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold text-gray-800">${project.title}</h3>
                                    <p class="text-sm text-gray-500">${new Date(project.createdAt.seconds * 1000).toLocaleDateString()}</p>
                                </div>
                                <span class="text-xs font-semibold bg-sky-100 text-sky-800 px-2 py-1 rounded-full">${project.status}</span>
                            </div>
                        `;
                        projectEl.onclick = () => viewProject(doc.id, project.title);
                        projectList.appendChild(projectEl);
                    });
                }
                 lucide.createIcons();
            });
        }
        
        function viewProject(projectId, projectTitle) {
            document.getElementById('hub-project-title').textContent = projectTitle;
            const tasksContainer = document.getElementById('project-tasks-container');
            tasksContainer.innerHTML = '<p>Loading tasks...</p>';
            
            const tasksRef = collection(db, `artifacts/${appId}/users/${currentUser.uid}/projects/${projectId}/tasks`);
            onSnapshot(query(tasksRef), (snapshot) => {
                tasksContainer.innerHTML = '';
                if(snapshot.empty) {
                     tasksContainer.innerHTML = '<p class="text-gray-500">No tasks found for this project.</p>';
                } else {
                    const tasks = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => a.wbsCode.localeCompare(b.wbsCode));
                    tasks.forEach(task => {
                        const isLocked = task.dependencies.length > 0 && task.dependencies.some(dep => !tasks.find(t => t.wbsCode === dep)?.isComplete);
                        const taskEl = document.createElement('label');
                        taskEl.className = `flex items-center p-3 rounded-lg border mb-3 transition-all ${
                            task.isComplete ? 'bg-green-50 border-green-200' : 
                            isLocked ? 'bg-gray-100 border-gray-200 text-gray-400 cursor-not-allowed' : 
                            'bg-white border-gray-200 shadow-sm'
                        }`;

                        taskEl.innerHTML = `
                             <input type="checkbox" ${task.isComplete ? 'checked' : ''} ${isLocked ? 'disabled' : ''} data-task-id="${task.id}" data-project-id="${projectId}" class="h-5 w-5 rounded border-gray-300 text-sky-600 focus:ring-sky-500">
                             <span class="ml-3 ${task.isComplete ? 'line-through' : ''}">${task.wbsCode}: ${task.description}</span>
                        `;
                         tasksContainer.appendChild(taskEl);
                    });
                }
                 lucide.createIcons();
            });

            navigateTo('project-hub-screen');
        }

        // --- NEW PROJECT MODAL ---
        document.getElementById('new-project-btn').addEventListener('click', () => {
            newProjectModal.style.display = 'flex';
        });
        document.getElementById('cancel-project-btn').addEventListener('click', () => {
             newProjectModal.style.display = 'none';
        });

        document.getElementById('new-project-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('project-title').value;
            const description = document.getElementById('project-description').value;
            
            // UI feedback for loading
            document.getElementById('create-btn-text').textContent = 'Generating...';
            document.getElementById('create-spinner').style.display = 'block';
            document.getElementById('create-project-btn').disabled = true;

            try {
                const wbs = await generateWBSWithAI(title, description);
                if (wbs && wbs.tasks) {
                    await saveProjectAndTasks(title, wbs.tasks);
                    newProjectModal.style.display = 'none';
                    e.target.reset();
                } else {
                    throw new Error("AI did not return a valid task list.");
                }
            } catch (error) {
                console.error("Failed to create project:", error);
                alert("Sorry, there was an error generating the project plan. Please try again.");
            } finally {
                // Restore button
                document.getElementById('create-btn-text').textContent = 'Generate Plan';
                document.getElementById('create-spinner').style.display = 'none';
                document.getElementById('create-project-btn').disabled = false;
            }
        });
        
        // --- TASK MANAGEMENT ---
        document.getElementById('project-tasks-container').addEventListener('change', async (e) => {
            if (e.target.type === 'checkbox') {
                const taskId = e.target.dataset.taskId;
                const projectId = e.target.dataset.projectId;
                const isComplete = e.target.checked;
                const taskRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/projects/${projectId}/tasks`, taskId);
                await updateDoc(taskRef, { isComplete: isComplete });
            }
        });


        // --- AI WBS GENERATION ---
        async function generateWBSWithAI(title, description) {
            const apiKey = ""; // Canvas will provide this
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const systemInstruction = `You are an expert home improvement project manager. Your task is to generate a detailed Work Breakdown Structure (WBS) for a DIY project. The user will provide a project title and description. You MUST respond with a valid JSON object containing a list of tasks. For each task, provide: 1. wbsCode: A hierarchical code (e.g., "1.0", "1.1"). 2. description: A clear, actionable task description. 3. dependencies: An array of wbsCodes for tasks that must be completed first. Leave empty if none. 4. estimatedTime: An object with three keys: novice, intermediate, and expert. The values should be your estimated completion time in minutes for each skill level. 5. requiredTools: A list of common tools needed for this specific task. 6. requiredMaterials: A list of common materials needed for this specific task.`;

            const userPrompt = `Title: ${title}\nDescription: ${description}`;

            const payload = {
                systemInstruction: { parts: [{ text: systemInstruction }] },
                contents: [{ parts: [{ text: userPrompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "tasks": {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        "wbsCode": { "type": "STRING" },
                                        "description": { "type": "STRING" },
                                        "dependencies": { "type": "ARRAY", "items": { "type": "STRING" } },
                                        "estimatedTime": { 
                                            "type": "OBJECT",
                                            "properties": {
                                                "novice": {"type": "NUMBER"},
                                                "intermediate": {"type": "NUMBER"},
                                                "expert": {"type": "NUMBER"}
                                            }
                                        },
                                        "requiredTools": { "type": "ARRAY", "items": { "type": "STRING" } },
                                        "requiredMaterials": { "type": "ARRAY", "items": { "type": "STRING" } }
                                    }
                                }
                            }
                        }
                    }
                }
            };
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                console.error("API Error:", response.status, await response.text());
                return null;
            }

            const result = await response.json();
            const jsonText = result.candidates[0].content.parts[0].text;
            return JSON.parse(jsonText);
        }

        async function saveProjectAndTasks(title, tasks) {
            const projectsRef = collection(db, `artifacts/${appId}/users/${currentUser.uid}/projects`);
            const newProjectRef = await addDoc(projectsRef, {
                title: title,
                status: 'In Progress',
                createdAt: new Date(),
                userId: currentUser.uid
            });

            const tasksRef = collection(db, `artifacts/${appId}/users/${currentUser.uid}/projects/${newProjectRef.id}/tasks`);
            for (const task of tasks) {
                await addDoc(tasksRef, {
                    ...task,
                    isComplete: false,
                    projectId: newProjectRef.id
                });
            }
        }


        // --- INITIALIZE APP ---
        window.onload = () => {
            initializeFirebase();
            lucide.createIcons();
        };

    </script>
</body>
</html>

